<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>GEX Sniper</title>
<style>
*{box-sizing:border-box;margin:0;padding:0}
body{background:#04040d;color:#e2e8f0;font-family:'SF Mono',Monaco,monospace;font-size:12px;overflow:hidden}
button{cursor:pointer;font-family:inherit;border:none;outline:none}
input,select{font-family:inherit;outline:none;background:#0d1117;color:#e2e8f0;border:1px solid #1e293b;border-radius:4px}
input::placeholder{color:#1e293b}
.btn{background:#0d1117;color:#64748b;border:1px solid #1e293b;border-radius:5px;padding:5px 12px;font-size:11px;transition:all .15s}
.btn:hover{border-color:#334155;color:#94a3b8}
.btn-go{background:#1d4ed8;color:#fff;border-radius:6px;padding:10px 24px;font-size:12px;font-weight:700;letter-spacing:1px;border:none;width:100%;transition:background .2s}
.btn-go:hover{background:#2563eb}
.badge{display:inline-block;padding:2px 6px;border-radius:3px;font-size:9px;font-weight:700;letter-spacing:1px}
/* SETUP */
#setup{position:fixed;inset:0;background:#04040d;z-index:999;display:flex;align-items:center;justify-content:center}
.setup-box{background:#07080f;border:1px solid #0f172a;border-radius:12px;padding:28px 32px;width:100%;max-width:500px}
.setup-title{font-size:18px;font-weight:700;color:#e2e8f0;letter-spacing:-0.5px}
.setup-sub{font-size:11px;color:#334155;margin:4px 0 20px}
.setup-lbl{font-size:9px;color:#475569;letter-spacing:1px;font-weight:700;margin-bottom:4px}
.setup-inp{width:100%;padding:9px 12px;font-size:12px;border-radius:5px;margin-bottom:12px}
.setup-err{color:#ef4444;font-size:11px;margin-top:8px;display:none;padding:6px 10px;background:#ef444410;border-radius:4px;border:1px solid #ef444430}
/* APP */
#app{display:none;flex-direction:column;height:100vh}
/* STATUS BAR */
#sbar{background:#060710;border-bottom:1px solid #0d0d1a;padding:5px 14px;display:flex;align-items:center;gap:10px;flex-wrap:wrap;flex-shrink:0}
#sb-price{font-size:24px;font-weight:700;color:#e2e8f0;letter-spacing:-0.5px;line-height:1}
#sb-chg{font-size:11px;margin-left:2px}
.sbl{font-size:9px;color:#1e293b;letter-spacing:1px}
.sbv{font-size:11px;color:#475569}
.sep{color:#0f172a;padding:0 2px}
/* TABS */
#tabs{background:#060710;border-bottom:1px solid #0d0d1a;display:flex;padding:0 12px;flex-shrink:0}
.tab{padding:7px 14px;font-size:10px;letter-spacing:1px;color:#1e293b;cursor:pointer;border-bottom:2px solid transparent;transition:all .15s;position:relative}
.tab.on{color:#e2e8f0;border-bottom-color:#1d4ed8}
.tab:hover:not(.on){color:#334155}
.tbadge{position:absolute;top:3px;right:3px;background:#f59e0b;color:#000;font-size:8px;font-weight:700;padding:1px 4px;border-radius:8px;display:none}
/* PANELS */
#content{flex:1;overflow:hidden;position:relative}
.panel{display:none;position:absolute;inset:0;overflow:auto}
.panel.on{display:flex}
/* SIGNALS PANEL — 3 col */
#p-signals{display:grid;grid-template-columns:270px 1fr 200px}
.col{padding:10px;display:flex;flex-direction:column;gap:8px;overflow-y:auto;height:100%}
.col:not(:last-child){border-right:1px solid #0a0a14}
/* APEX CARD */
.apex-card{border-radius:10px;padding:16px;border-left-width:4px;border-left-style:solid;flex:1}
.apex-state{font-size:9px;letter-spacing:2px;font-weight:700}
.apex-dir{font-size:30px;font-weight:700;letter-spacing:2px;line-height:1.1;margin:4px 0 2px}
.apex-sub{font-size:10px;color:#334155;margin-bottom:10px;min-height:14px}
.apex-grid{display:grid;grid-template-columns:1fr 1fr 1fr;gap:5px;margin-bottom:8px}
.apex-cell{background:#08080f;border-radius:4px;padding:6px 8px}
.apex-cl{font-size:8px;color:#334155;letter-spacing:1px;margin-bottom:2px}
.apex-cv{font-size:14px;font-weight:700}
.apex-score-row{display:flex;align-items:baseline;gap:5px;margin-top:10px}
.apex-score{font-size:38px;font-weight:700;line-height:1}
.apex-denom{font-size:12px;color:#1e293b}
.apex-bar{height:5px;background:#0a0a14;border-radius:3px;overflow:hidden;margin-top:5px}
.apex-fill{height:100%;border-radius:3px;transition:width .8s}
.ctx{margin-top:6px;padding:6px 9px;border-radius:4px;font-size:10px}
.ctx-lbl{font-size:9px;font-weight:700;letter-spacing:1px}
/* SIGNAL CARDS */
.sc{background:#060710;border:1px solid #0a0a14;border-left:3px solid #0a0a14;border-radius:7px;padding:11px 13px;display:grid;grid-template-columns:1fr 68px;gap:10px;align-items:center;transition:all .3s}
.sc.call{background:#030e07;border-color:#10b98140;border-left-color:#10b981}
.sc.put{background:#0e0303;border-color:#ef444440;border-left-color:#ef4444}
.sc-type{font-size:9px;color:#1e293b;letter-spacing:2px;font-weight:700}
.sc-name{font-size:13px;font-weight:700;color:#334155;margin:2px 0 1px}
.sc-name.on{color:#e2e8f0}
.sc-sub{font-size:10px;color:#1e293b;margin-bottom:4px}
.sc-detail{font-size:10px;color:#334155;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.sc-detail.on{color:#94a3b8}
.sc-score{font-size:24px;font-weight:700;text-align:right;line-height:1}
.sc-denom{font-size:9px;color:#1e293b;text-align:right}
.sc-bar{height:3px;background:#0a0a14;border-radius:2px;overflow:hidden;margin-top:6px;grid-column:1/-1}
.sc-fill{height:100%;border-radius:2px;transition:width .8s}
/* GEX COL */
.gl-row{display:flex;justify-content:space-between;align-items:center;padding:5px 0;border-bottom:1px solid #070710}
.gl-lbl{font-size:10px;color:#334155}
.gl-val{font-size:13px;font-weight:700}
/* FLOW TAB */
.flow-hdr{display:grid;grid-template-columns:52px 42px 55px 52px 72px 1fr;gap:8px;padding:7px 14px;border-bottom:1px solid #0a0a14;font-size:9px;color:#1e293b;letter-spacing:1px;font-weight:700;flex-shrink:0}
.flow-row{display:grid;grid-template-columns:52px 42px 55px 52px 72px 1fr;gap:8px;padding:5px 14px;border-bottom:1px solid #06070f;font-size:11px;align-items:center}
.flow-row:hover{background:#06070f}
/* GEX TAB */
.gex-row{display:grid;grid-template-columns:58px 90px 80px 80px 70px;gap:8px;padding:4px 14px;align-items:center;font-size:11px}
/* SUMMARY */
.sum-sec{padding:12px 16px;border-bottom:1px solid #06070f}
.sum-ttl{font-size:9px;color:#1e293b;letter-spacing:2px;font-weight:700;margin-bottom:8px}
/* SETTINGS */
#settings{display:none;position:fixed;inset:0;background:#00000099;z-index:100;align-items:center;justify-content:center}
#settings.on{display:flex}
.settings-box{background:#07080f;border:1px solid #0f172a;border-radius:10px;padding:22px;width:460px;max-height:85vh;overflow-y:auto}
::-webkit-scrollbar{width:3px;height:3px}
::-webkit-scrollbar-thumb{background:#1e293b;border-radius:2px}
</style>
</head>
<body>

<!-- SETUP -->
<div id="setup">
  <div class="setup-box">
    <div class="setup-title">⬡ GEX SNIPER</div>
    <div class="setup-sub">SPY 0DTE · Dealer Pressure · Fresh Positioning · Release Imminent</div>
    <div class="setup-lbl">POLYGON API KEY</div>
    <input id="k-poly" class="setup-inp" type="password" placeholder="Required for price + delta stream"/>
    <div class="setup-lbl">UNUSUAL WHALES KEY</div>
    <input id="k-uw" class="setup-inp" type="password" placeholder="Flow prints + dark pool"/>
    <div class="setup-lbl">TRADIER KEY</div>
    <input id="k-trad" class="setup-inp" type="password" placeholder="Options chain + GEX"/>
    <div class="setup-lbl">PUSHOVER TOKEN</div>
    <input id="k-ptoken" class="setup-inp" type="password" placeholder="SMS alerts (optional)"/>
    <div class="setup-lbl">PUSHOVER USER KEY</div>
    <input id="k-puser" class="setup-inp" type="password" placeholder="SMS alerts (optional)"/>
    <button class="btn-go" onclick="launch()">CONNECT & LAUNCH →</button>
    <div id="setup-err" class="setup-err"></div>
  </div>
</div>

<!-- SETTINGS MODAL -->
<div id="settings">
  <div class="settings-box">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px">
      <span style="font-size:13px;font-weight:700;color:#e2e8f0">SETTINGS</span>
      <button class="btn" onclick="closeSetting()">✕</button>
    </div>
    <div class="setup-lbl">POLYGON KEY</div><input id="s-poly" class="setup-inp" type="password"/>
    <div class="setup-lbl">UNUSUAL WHALES KEY</div><input id="s-uw" class="setup-inp" type="password"/>
    <div class="setup-lbl">TRADIER KEY</div><input id="s-trad" class="setup-inp" type="password"/>
    <div class="setup-lbl">PUSHOVER TOKEN</div><input id="s-ptoken" class="setup-inp" type="password"/>
    <div class="setup-lbl">PUSHOVER USER KEY</div><input id="s-puser" class="setup-inp" type="password"/>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:12px">
      <div><div class="setup-lbl">TARGET ($)</div><input id="s-tgt" class="setup-inp" type="number" step="0.25" style="margin-bottom:0"/></div>
      <div><div class="setup-lbl">STOP ($)</div><input id="s-stop" class="setup-inp" type="number" step="0.25" style="margin-bottom:0"/></div>
    </div>
    <div style="display:flex;align-items:center;gap:8px;margin-bottom:16px">
      <input type="checkbox" id="s-sms" style="width:auto;background:none"/>
      <label for="s-sms" style="font-size:11px;color:#475569;cursor:pointer">SMS on APEX fire</label>
    </div>
    <div style="display:flex;gap:8px">
      <button class="btn-go" onclick="saveSetting()" style="flex:1;padding:8px">SAVE</button>
      <button class="btn" onclick="disconnect()" style="color:#ef4444;border-color:#ef444430;padding:8px 16px">DISCONNECT</button>
    </div>
  </div>
</div>

<!-- APP -->
<div id="app">
  <!-- STATUS BAR -->
  <div id="sbar">
    <span style="font-size:9px;color:#1d4ed8;font-weight:700;letter-spacing:2px">⬡ GEX SNIPER</span>
    <span id="sb-price">$—</span>
    <span id="sb-chg">—</span>
    <span class="sep">|</span>
    <span class="sbl">O</span><span id="sb-o" class="sbv">—</span>
    <span class="sbl">H</span><span id="sb-h" class="sbv">—</span>
    <span class="sbl">L</span><span id="sb-l" class="sbv">—</span>
    <span class="sep">|</span>
    <span class="sbl">GEX</span>
    <span id="sb-regime" class="badge" style="background:#0a0a14;color:#1e293b">—</span>
    <span id="sb-glevels" class="sbv">—</span>
    <span class="sep">|</span>
    <span class="sbl">VWAP</span><span id="sb-vwap" class="sbv">—</span>
    <span class="sep">|</span>
    <span class="sbl">VIX</span><span id="sb-vix" class="sbv">—</span>
    <span class="sep">|</span>
    <span class="sbl">FLOW</span><span id="sb-flow" class="sbv">—</span>
    <span class="sep">|</span>
    <span id="sb-sigs" style="font-size:11px;color:#334155">Dealer — · Positioning — · Release —</span>
    <div style="margin-left:auto;display:flex;align-items:center;gap:8px">
      <span id="sb-poly" style="font-size:9px;color:#1e293b" title="Polygon">●P</span>
      <span id="sb-uw"   style="font-size:9px;color:#1e293b" title="UW">●U</span>
      <span id="sb-trad" style="font-size:9px;color:#1e293b" title="Tradier">●T</span>
      <span id="sb-ws"   style="font-size:9px;color:#1e293b" title="Stream">Δ</span>
      <button class="btn" onclick="openSetting()" style="padding:3px 8px;font-size:10px">⚙</button>
      <button class="btn" onclick="sendAMBrief()" style="padding:3px 8px;font-size:10px">AM BRIEF</button>
      <span id="sb-clock" style="font-size:10px;color:#1e293b;min-width:65px;text-align:right"></span>
    </div>
  </div>

  <!-- TABS -->
  <div id="tabs">
    <div class="tab on" onclick="switchTab('signals')">SIGNALS<span id="badge-signals" class="tbadge"></span></div>
    <div class="tab" onclick="switchTab('flow')">FLOW</div>
    <div class="tab" onclick="switchTab('gex')">GEX</div>
    <div class="tab" onclick="switchTab('orders')">ORDERS<span id="badge-orders" class="tbadge">0</span></div>
    <div class="tab" onclick="switchTab('summary')">SUMMARY</div>
  </div>

  <!-- CONTENT -->
  <div id="content">

    <!-- SIGNALS -->
    <div id="p-signals" class="panel on">
      <div class="col" id="col-apex"></div>
      <div class="col" id="col-signals"></div>
      <div class="col" id="col-gex"></div>
    </div>

    <!-- FLOW -->
    <div id="p-flow" class="panel" style="flex-direction:column">
      <div class="flow-hdr"><span>TIME</span><span>TYPE</span><span>STRIKE</span><span>EXP</span><span>PREMIUM</span><span>FLAGS</span></div>
      <div id="flow-body" style="flex:1;overflow-y:auto"></div>
    </div>

    <!-- GEX DIAGNOSTIC -->
    <div id="p-gex" class="panel" style="flex-direction:column">
      <div style="padding:10px 14px;border-bottom:1px solid #0a0a14;display:flex;gap:10px;align-items:center;flex-shrink:0;flex-wrap:wrap">
        <span style="font-size:9px;color:#334155;letter-spacing:1px;font-weight:700">GEX DIAGNOSTIC</span>
        <span id="gex-status" style="font-size:10px;color:#334155">—</span>
        <div style="margin-left:auto;display:flex;gap:6px;align-items:center">
          <span class="setup-lbl" style="align-self:center">MANUAL OVERRIDE</span>
          <input id="ov-flip"  type="number" placeholder="Flip"  style="width:66px;padding:4px 7px;font-size:11px"/>
          <input id="ov-cwall" type="number" placeholder="CWall" style="width:66px;padding:4px 7px;font-size:11px"/>
          <input id="ov-pwall" type="number" placeholder="PWall" style="width:66px;padding:4px 7px;font-size:11px"/>
          <button class="btn" onclick="applyManual()" style="font-size:10px;padding:4px 10px">APPLY</button>
          <button class="btn" onclick="clearManual()" style="font-size:10px;padding:4px 10px">CLEAR</button>
        </div>
      </div>
      <div class="gex-row" style="font-size:9px;color:#1e293b;letter-spacing:1px;font-weight:700;border-bottom:1px solid #0a0a14;padding-top:8px;padding-bottom:8px;flex-shrink:0">
        <span>STRIKE</span><span>NET GEX</span><span>BLEND %</span><span>CALL GEX</span><span>PUT GEX</span>
      </div>
      <div id="gex-rows" style="flex:1;overflow-y:auto"></div>
    </div>

    <!-- ORDERS -->
    <div id="p-orders" class="panel" style="flex-direction:column">
      <div id="orders-body" style="flex:1;overflow-y:auto;padding:12px"></div>
    </div>

    <!-- SUMMARY -->
    <div id="p-summary" class="panel" style="flex-direction:column">
      <div id="summary-body" style="flex:1;overflow-y:auto"></div>
    </div>

  </div>
</div>

<script>
'use strict';

// ════════════════════════════════════════════════════
// CONSTANTS
// ════════════════════════════════════════════════════
const CFG = {
  STRIKE_BAND:      6,       // L18: ±$6 only
  MIN_GAMMA:        0.01,
  MIN_OI:           100,
  MIN_VOL_BLEND:    500,     // contracts before volume activates blend
  GEX_STALE_MIN:    3,       // L3
  FLOW_WIN_MS:      30*60000,// L7: 30-min window only
  OTM_BAND:         2.0,     // L8
  DP_CLUSTER:       1.00,
  DP_PROX:          1.50,
  APEX_MIN:         45,
  APEX_TGT:         4.00,
  APEX_STOP:        0.75,
  WALL_BLOCK:       1.50,    // L9
  WALL_WARN:        2.50,
  COOLDOWN_MS:      3*60000,
  LEVEL_CD_MS:      10*60000,
  EXPIRY_MS:        45*60000,
  BO_AM_S:          9*60+30, // 9:30
  BO_AM_E:          10*60,   // 10:00
  BO_PM_S:          15*60+30,// 3:30
  BO_PM_E:          16*60,   // 4:00
  SNAP_MAX:         20,      // GEX snapshots to keep
  WAVE_MIN_TICKS:   8,
};
const LOGKEY = 'gexsniper_v4_log';

// ════════════════════════════════════════════════════
// STATE
// ════════════════════════════════════════════════════
let K = {poly:'',uw:'',trad:'',ptoken:'',puser:''};
let CON = {poly:false,uw:false,trad:false,ws:false};
let SMS_ON = false;
let TGT = CFG.APEX_TGT, STOP = CFG.APEX_STOP;

// Price
let price=0, chg=0, meta={o:0,h:0,l:0};
let c5=[], c15=[], vwap=0;

// Flow / DP
let uwFlow=[], dpLevels=[];

// GEX
let gexSnaps=[];        // [{ts, byStrike}] — L11: full per-strike volume
let gexLevels=null;     // Layer 2 output — single source of truth
let gexValid=false, gexFetching=false, gexLastAt=null;
let gexOverride=null;   // emergency manual only
let flipEvents=[];      // [{ts,price,toPos}]
let prevPosGEX=null;

// IV
let ivHist=[];          // [{ts,atmIV,callIV,putIV}]

// Delta / waves
let polyWS=null;
let dTicks=[];
let dLastP=0;
let dWaves=[];          // [{dir,tickCount,priceMove,efficiency,ts}]
let dWaveCur=null;      // {dir,startP,startTs,ticks}

// APEX
let apex=null;
let lastFireAt=0, lastFireKey='';

// Intervals
let ivPrice=null, ivCandle=null, ivGEX=null, ivFlow=null, ivClock=null;
let lastScanAt=0;
let curTab='signals';

// ════════════════════════════════════════════════════
// LAYER 1 — DATA
// ════════════════════════════════════════════════════

function tradDate(){
  const n=new Date(),d=n.getDay(),dt=new Date(n);
  dt.setDate(dt.getDate()-(d===6?1:d===0?2:0));
  return dt.toISOString().split('T')[0];
}
function etNow(){return new Date(new Date().toLocaleString('en-US',{timeZone:'America/New_York'}))}
function etMins(){const e=etNow();return e.getHours()*60+e.getMinutes();}
function isMarket(){const e=etNow(),d=e.getDay(),m=etMins();return d>=1&&d<=5&&m>=570&&m<960;}

async function polyGet(path){
  const url=`https://api.polygon.io${path}${path.includes('?')?'&':'?'}apiKey=${K.poly}`;
  const r=await fetch(url);
  const d=await r.json();
  if(d.status==='ERROR'||d.status==='FORBIDDEN') throw new Error(d.error||'Polygon error');
  return d;
}

// WebSocket — tick stream (L4/L5)
function connectWS(){
  if(!K.poly) return;
  if(polyWS){try{polyWS.close();}catch(e){}}
  try{
    polyWS=new WebSocket('wss://socket.polygon.io/stocks');
    polyWS.onopen=()=>polyWS.send(JSON.stringify({action:'auth',params:K.poly}));
    polyWS.onmessage=(e)=>{
      const msgs=JSON.parse(e.data);
      for(const m of msgs){
        if(m.ev==='status'&&m.status==='auth_success'){
          polyWS.send(JSON.stringify({action:'subscribe',params:'T.SPY'}));
          CON.ws=true; updDots();
        }
        if(m.ev==='T'&&m.sym==='SPY') onTick(m.p,m.s||1);
      }
    };
    polyWS.onclose=()=>{CON.ws=false;updDots();setTimeout(connectWS,5000);};
    polyWS.onerror=()=>{CON.ws=false;updDots();};
  }catch(e){CON.ws=false;}
}

function onTick(p,sz){
  const ts=Date.now();
  // L4: update price before scan; L5: throttle to 1/sec
  if(p>0&&Math.abs(p-price)<10){
    price=p;
    updPrice();
    if(ts-lastScanAt>1000){lastScanAt=ts;scan();}
  }
  // Delta wave tracking
  if(!dLastP){dLastP=p;return;}
  const dir=p>dLastP?1:p<dLastP?-1:0;
  dLastP=p;
  if(!dir) return;
  dTicks.push({p,dir,ts,sz});
  if(dTicks.length>600) dTicks.shift();
  const wd=dir>0?'CALL':'PUT';
  if(!dWaveCur){
    dWaveCur={dir:wd,startP:p,startTs:ts,ticks:1};
  } else if(dWaveCur.dir===wd){
    dWaveCur.ticks++;
  } else {
    if(dWaveCur.ticks>=CFG.WAVE_MIN_TICKS){
      const mv=Math.abs(p-dWaveCur.startP);
      dWaves.push({dir:dWaveCur.dir,tickCount:dWaveCur.ticks,
        priceMove:mv,efficiency:mv/dWaveCur.ticks*100,ts:dWaveCur.startTs});
      if(dWaves.length>16) dWaves.shift();
    }
    dWaveCur={dir:wd,startP:p,startTs:ts,ticks:1};
  }
}

// Price snapshot + VIX (L1: I:VIX — L1 rule)
async function fetchPrice(){
  try{
    const [rs,rv]=await Promise.all([
      polyGet('/v2/snapshot/locale/us/markets/stocks/tickers/SPY'),
      polyGet('/v2/snapshot/locale/us/markets/indices/tickers/I:VIX').catch(()=>null)
    ]);
    const sn=rs.ticker;
    if(!CON.ws){price=sn.day?.c||sn.prevDay?.c||price;}
    chg=sn.todaysChange||0;
    meta={o:sn.day?.o||0,h:sn.day?.h||0,l:sn.day?.l||0};
    if(rv?.results?.length){
      const vx=rv.results[0]?.value||0;
      const el=G('sb-vix');
      if(el&&vx>0){el.textContent=vx.toFixed(2);el.style.color=vx>25?'#ef4444':vx>18?'#f59e0b':'#10b981';}
    }
    CON.poly=true; updDots(); updPrice();
  }catch(e){}
}

async function fetchCandles(){
  try{
    const dt=tradDate();
    const [r5,r15]=await Promise.all([
      polyGet(`/v2/aggs/ticker/SPY/range/5/minute/${dt}/${dt}?adjusted=false&sort=asc&limit=200`),
      polyGet(`/v2/aggs/ticker/SPY/range/15/minute/${dt}/${dt}?adjusted=false&sort=asc&limit=100`)
    ]);
    if(r5.results?.length) c5=r5.results.map(b=>({t:b.t,o:b.o,h:b.h,l:b.l,c:b.c,v:b.v}));
    if(r15.results?.length) c15=r15.results.map(b=>({t:b.t,o:b.o,h:b.h,l:b.l,c:b.c,v:b.v}));
    if(c5.length){let tv=0,vv=0;for(const c of c5){const tp=(c.h+c.l+c.c)/3;tv+=tp*c.v;vv+=c.v;}vwap=vv?tv/vv:0;}
  }catch(e){}
}

async function fetchTradChain(exp){
  const r=await fetch(
    `https://api.tradier.com/v1/markets/options/chains?symbol=SPY&expiration=${exp}&greeks=true`,
    {headers:{'Authorization':`Bearer ${K.trad}`,'Accept':'application/json'}}
  );
  if(!r.ok) throw new Error(`Tradier ${r.status}`);
  const d=await r.json();
  return d.options?.option||[];
}

async function fetchGEX(){
  if(!K.trad||gexFetching) return;
  gexFetching=true;
  try{
    // Get expiries
    const re=await fetch(
      'https://api.tradier.com/v1/markets/options/expirations?symbol=SPY&includeAllRoots=false',
      {headers:{'Authorization':`Bearer ${K.trad}`,'Accept':'application/json'}}
    );
    if(!re.ok) throw new Error('Tradier expiries');
    const de=await re.json();
    const exps=de.expirations?.date||[];
    if(!exps.length) throw new Error('No expiries');

    const chain=await fetchTradChain(exps[0]);
    if(!chain.length) throw new Error('Empty chain');

    // L11: store full per-strike volume snapshot
    const snap=buildSnap(chain);
    gexSnaps.push({ts:Date.now(),byStrike:snap});
    if(gexSnaps.length>CFG.SNAP_MAX) gexSnaps.shift();

    // Capture IV snapshot
    snapIV(chain);

    // Compute Layer 2 levels
    gexLevels=computeGEX(chain);
    gexValid=true; gexLastAt=new Date(); CON.trad=true; updDots();

    // Flip event detection
    if(gexLevels&&price>0){
      const pos=price>gexLevels.flip;
      if(prevPosGEX!==null&&pos!==prevPosGEX){
        flipEvents.push({ts:Date.now(),price,toPos:pos});
        if(flipEvents.length>10) flipEvents.shift();
      }
      prevPosGEX=pos;
    }
    if(curTab==='gex') renderGEXTab();
  }catch(e){gexValid=false;console.warn('GEX:',e.message);}
  finally{gexFetching=false;}
}

function buildSnap(chain){
  const s={};
  for(const c of chain){
    if(!c.strike||!c.greeks?.gamma) continue;
    const k=c.strike;
    if(!s[k]) s[k]={callOI:0,putOI:0,callVol:0,putVol:0,callG:0,putG:0};
    if(c.option_type==='call'){s[k].callOI+=c.open_interest||0;s[k].callVol+=c.volume||0;s[k].callG+=c.greeks.gamma||0;}
    else{s[k].putOI+=c.open_interest||0;s[k].putVol+=c.volume||0;s[k].putG+=c.greeks.gamma||0;}
  }
  return s;
}

function snapIV(chain){
  if(!price||!chain.length) return;
  const sorted=chain.filter(c=>c.greeks?.mid_iv).sort((a,b)=>Math.abs(a.strike-price)-Math.abs(b.strike-price));
  if(!sorted.length) return;
  const atmIV=sorted[0].greeks.mid_iv||0;
  const nc=chain.filter(c=>c.option_type==='call'&&Math.abs(c.strike-price)<=3&&c.greeks?.mid_iv);
  const np=chain.filter(c=>c.option_type==='put' &&Math.abs(c.strike-price)<=3&&c.greeks?.mid_iv);
  const callIV=nc.length?nc.reduce((a,c)=>a+(c.greeks.mid_iv||0),0)/nc.length:atmIV;
  const putIV =np.length?np.reduce((a,c)=>a+(c.greeks.mid_iv||0),0)/np.length:atmIV;
  if(atmIV>0){ivHist.push({ts:Date.now(),atmIV,callIV,putIV});if(ivHist.length>20)ivHist.shift();}
}

async function fetchFlow(){
  if(!K.uw) return;
  try{
    const r=await fetch('https://api.unusualwhales.com/api/option-trades/flow-feed?ticker=SPY&limit=200',
      {headers:{'Authorization':`Bearer ${K.uw}`,'Accept':'application/json'}});
    if(!r.ok) throw new Error(`UW ${r.status}`);
    const d=await r.json();
    const raw=d.data||d||[];
    uwFlow=raw.map(f=>({
      ts:f.updated_at?new Date(f.updated_at).getTime():f.created_at?new Date(f.created_at).getTime():Date.now(),
      type:(f.type||f.put_call||'').toUpperCase().includes('CALL')?'CALL':'PUT',
      strike:+(f.strike||f.strike_price||0),
      expiry:f.expiry||f.expiration_date||'',
      premium:+(f.premium||f.total_premium||0),
      size:+(f.size||f.volume||0),
      sweep:!!(f.is_sweep||f.sweep)
    })).filter(f=>f.premium>50000);
    CON.uw=true; updDots();
    if(curTab==='flow') renderFlowTab();
  }catch(e){}
}

async function fetchDP(){
  if(!K.uw) return;
  try{
    const r=await fetch('https://api.unusualwhales.com/api/darkpool/SPY?limit=500',
      {headers:{'Authorization':`Bearer ${K.uw}`,'Accept':'application/json'}});
    if(!r.ok) throw new Error(`DP ${r.status}`);
    const d=await r.json();
    const trades=d.data||d||[];
    const clusters=[];
    for(const t of trades){
      const p=+(t.price||0);if(!p) continue;
      const pr=+(t.premium||0);if(pr<1e6) continue;
      const ex=clusters.find(c=>Math.abs(c.price-p)<CFG.DP_CLUSTER);
      if(ex){ex.tot+=pr;ex.n++;ex.price=(ex.price*(ex.n-1)+p)/ex.n;}
      else clusters.push({price:p,tot:pr,n:1});
    }
    dpLevels=clusters.sort((a,b)=>b.tot-a.tot).slice(0,8);
  }catch(e){}
}

// ════════════════════════════════════════════════════
// LAYER 2 — GEX LEVELS (single source of truth)
// ════════════════════════════════════════════════════

function vol15Delta(){
  // Recency-weighted 15m volume deltas per strike
  if(gexSnaps.length<2) return {};
  const now=Date.now();
  const bounds=[0,15,30,45].map(m=>now-m*60000);
  const weights=[1.0,0.5,0.2,0.05];
  const getSnap=t=>gexSnaps.reduce((b,s)=>Math.abs(s.ts-t)<Math.abs(b.ts-t)?s:b,gexSnaps[0]);
  const snaps=bounds.map(b=>getSnap(b));
  const all=new Set();
  snaps.forEach(s=>Object.keys(s.byStrike||{}).forEach(k=>all.add(+k)));
  const res={};
  for(const st of all){
    let w=0;
    for(let i=0;i<snaps.length-1;i++){
      const cur=snaps[i]?.byStrike?.[st];
      const prv=snaps[i+1]?.byStrike?.[st];
      if(cur&&prv){
        const dv=Math.max(0,(cur.callVol+cur.putVol)-(prv.callVol+prv.putVol));
        w+=dv*weights[i];
      }
    }
    if(w>0) res[st]=w;
  }
  return res;
}

function computeGEX(chain){
  if(!chain.length||!price) return null;
  const spot=price;
  // L18: ±$6 band, L13: gamma ≥ 0.01, min OI 100
  const filt=chain.filter(c=>
    c.strike&&Math.abs(c.strike-spot)<=CFG.STRIKE_BAND&&
    (c.open_interest||0)>=CFG.MIN_OI&&c.greeks?.gamma>=CFG.MIN_GAMMA
  );
  if(filt.length<3) return null;

  // Aggregate per strike
  const by={};
  for(const c of filt){
    const k=c.strike;
    if(!by[k]) by[k]={callOI:0,putOI:0,callVol:0,putVol:0,callG:0,putG:0};
    if(c.option_type==='call'){by[k].callOI+=c.open_interest||0;by[k].callVol+=c.volume||0;by[k].callG+=c.greeks.gamma||0;}
    else{by[k].putOI+=c.open_interest||0;by[k].putVol+=c.volume||0;by[k].putG+=c.greeks.gamma||0;}
  }

  const vol15=vol15Delta();
  const strikes=Object.keys(by).map(Number).sort((a,b)=>a-b);
  let blendActive=false;

  for(const s of strikes){
    const b=by[s];
    const totOI=(b.callOI+b.putOI)||1;
    const rvol=vol15[s]||(b.callVol+b.putVol);
    const repo=Math.min(1.0,rvol>=CFG.MIN_VOL_BLEND?rvol/totOI:0);
    if(repo>0.05) blendActive=true;
    b.repo=repo;
    // OI-based GEX
    const cGex_OI = -b.callOI * b.callG * 100 * spot;
    const pGex_OI =  b.putOI  * b.putG  * 100 * spot;
    // Volume-based GEX
    const cGex_V  = -b.callVol* b.callG * 100 * spot;
    const pGex_V  =  b.putVol * b.putG  * 100 * spot;
    const netOI   = cGex_OI+pGex_OI;
    const netVol  = cGex_V+pGex_V;
    b.netGEX = netOI*(1-repo) + netVol*repo;
  }

  // L2: flip = nearest zero-crossing outward from spot
  const nearI=strikes.reduce((bi,s,i)=>Math.abs(s-spot)<Math.abs(strikes[bi]-spot)?i:bi,0);
  let flip=null;
  for(let i=nearI;i<strikes.length-1&&flip===null;i++){
    const g0=by[strikes[i]].netGEX,g1=by[strikes[i+1]].netGEX;
    if((g0<=0&&g1>0)||(g0>=0&&g1<0)) flip=Math.abs(g0)<Math.abs(g1)?strikes[i]:strikes[i+1];
  }
  for(let i=nearI;i>0&&flip===null;i--){
    const g0=by[strikes[i]].netGEX,g1=by[strikes[i-1]].netGEX;
    if((g0<=0&&g1>0)||(g0>=0&&g1<0)) flip=Math.abs(g0)<Math.abs(g1)?strikes[i]:strikes[i-1];
  }
  if(flip===null) flip=strikes[nearI];

  // Walls — peak dealer obligation
  const abv=strikes.filter(s=>s>spot);
  const blw=strikes.filter(s=>s<=spot);
  const cwall=abv.length?abv.reduce((b,s)=>(by[s].callOI*by[s].callG)>(by[b].callOI*by[b].callG)?s:b,abv[0]):strikes[strikes.length-1];
  const pwall=blw.length?blw.reduce((b,s)=>(by[s].putOI*by[s].putG)>(by[b].putOI*by[b].putG)?s:b,blw[0]):strikes[0];

  // Hedge acceleration
  let accelD=0,accelU=0;
  for(const s of strikes){
    if(s<=spot&&s>=spot-2) accelD+=Math.abs(by[s].netGEX);
    if(s>=spot&&s<=spot+2) accelU+=Math.abs(by[s].netGEX);
  }

  let res={
    flip:+flip,callWall:+cwall,putWall:+pwall,
    regime:spot>+flip?'POS':'NEG',
    accelD:accelD/1e6,accelU:accelU/1e6,
    by,strikes,contracts:filt.length,blendActive,isManual:false
  };

  // Manual override — emergency only (badges as MANUAL)
  if(gexOverride){
    res.flip=gexOverride.flip;
    res.callWall=gexOverride.cwall;
    res.putWall=gexOverride.pwall;
    res.regime=price>gexOverride.flip?'POS':'NEG';
    res.isManual=true;
  }
  return res;
}

function gexAge(){return gexLastAt?(Date.now()-gexLastAt.getTime())/60000:999;}
function gexStale(){return gexAge()>CFG.GEX_STALE_MIN;}
function nearDP(p){return dpLevels.find(d=>Math.abs(d.price-p)<CFG.DP_PROX)||null;}

// ════════════════════════════════════════════════════
// LAYER 3 — SIGNALS
// ════════════════════════════════════════════════════

// Signal 1: DEALER PRESSURE
function scoreDealerPressure(){
  const nil=(d)=>({active:false,direction:null,score:0,accelD:0,accelU:0,urgency:0,detail:d,regime:'UNKNOWN'});
  if(!gexValid||gexStale()) return nil(!gexValid?`GEX loading — ${K.trad?'key loaded':'no Tradier key'}`:`GEX stale — ${gexAge().toFixed(1)}m old`);
  if(!gexLevels) return nil('GEX not computed');
  const{flip,callWall:cw,putWall:pw,regime,accelD,accelU}=gexLevels;
  const dFlip=Math.abs(price-flip);
  const dCW=cw-price;   // + = above
  const dPW=price-pw;   // + = below
  const totA=(accelD+accelU)||1;
  const urgency=(accelD-accelU)/totA; // +1=PUT bias
  const urgDir=urgency>0.10?'PUT':urgency<-0.10?'CALL':null;

  // Velocity gate (L14)
  const mv30=c5.length>=6?Math.abs(price-c5[c5.length-6].c):0;
  const vBlocked=mv30>2.0&&Math.max(accelD,accelU)<8;

  let score=0,dir=null,detail='';
  if(regime==='POS'){
    if(dCW>0&&dCW<3.0){score=62;dir='PUT';detail=`Approaching call wall $${cw} (+$${dCW.toFixed(2)}) · dealer forced selling`;}
    else if(dPW>0&&dPW<3.0){score=64;dir='CALL';detail=`Near put wall $${pw} (-$${dPW.toFixed(2)}) · dealer forced buying`;}
    else{score=36;dir=dCW<dPW?'PUT':'CALL';detail=`Pos GEX · between walls · magnet ${dir==='PUT'?'$'+cw:'$'+pw}`;}
  } else {
    if(dFlip<1.5){score=58;dir=null;detail=`At gamma flip $${flip} ±$${dFlip.toFixed(2)} — break direction decides`;}
    else if(price<flip){score=72;dir='PUT';detail=`Neg GEX — below flip $${flip} · dealers amplify declines · magnet $${pw}`;}
    else{score=62;dir='CALL';detail=`Neg GEX — above flip $${flip} · dealers amplify rallies · magnet $${cw}`;}
  }

  // Urgency modifier
  if(urgDir===dir&&Math.abs(urgency)>0.10){
    score+=Math.round(Math.abs(urgency)*18);
    detail+=` · accel ${dir==='PUT'?accelD.toFixed(0):accelU.toFixed(0)}M urgency ${Math.round(Math.abs(urgency)*100)}%`;
  } else if(urgDir&&urgDir!==dir){
    score-=10;detail+=` · ⚠ accel disagrees`;
  }

  // Recent flip bonus
  if(flipEvents.length&&Date.now()-flipEvents.at(-1).ts<8*60000){
    const ev=flipEvents.at(-1);
    const fd=ev.toPos?'CALL':'PUT';
    if(fd===dir){score+=15;detail+=` · regime flip ${fd} <8m`;}
  }

  // Velocity gate caps
  if(vBlocked){score=Math.min(score,40);detail+=` · ⚠ velocity gate`;}

  score=Math.max(0,Math.min(100,score));
  const active=score>=CFG.APEX_MIN&&dir!==null&&!vBlocked;
  return{active,direction:dir,score,accelD,accelU,urgency,flip,callWall:cw,putWall:pw,regime,detail};
}

// Signal 2: FRESH POSITIONING
function scoreFreshPositioning(){
  const nil=(d)=>({active:false,direction:null,score:0,callFlow:0,putFlow:0,otmBias:null,detail:d});
  if(!uwFlow.length) return nil('No flow data — UW key required');
  const now=Date.now();
  const recent=uwFlow.filter(f=>(now-f.ts)<=CFG.FLOW_WIN_MS);
  if(!recent.length) return nil('No flow in last 30m — window clear');

  let wC=0,wP=0,otmC=0,otmP=0;
  for(const f of recent){
    const otm=Math.abs((f.strike||0)-price)>CFG.OTM_BAND;
    const w=otm?4.0:0.5;
    if(f.type==='CALL'){wC+=f.premium*w;if(otm)otmC+=f.premium;}
    else{wP+=f.premium*w;if(otm)otmP+=f.premium;}
  }
  const tot=wC+wP||1;
  const ratio=wC/tot;
  const otmTot=otmC+otmP||1;
  const otmR=otmC/otmTot;
  const otmBias=otmTot>100000?(otmR>0.60?'CALL':otmR<0.40?'PUT':null):null;
  const blendDir=ratio>=0.60?'CALL':ratio<=0.40?'PUT':null;
  const dir=otmBias||blendDir;

  let score=0;
  if(dir){
    score=Math.round(45+Math.abs(ratio-0.5)*80+(otmTot>50000?Math.abs(otmR-0.5)*30:0));
    const l10=recent.filter(f=>(now-f.ts)<=600000).reduce((a,f)=>a+f.premium,0);
    const totPr=recent.reduce((a,f)=>a+f.premium,0);
    if(totPr>0&&l10/totPr>0.5) score+=10;
  } else score=Math.round(15+Math.abs(ratio-0.5)*30);
  score=Math.max(0,Math.min(100,score));
  const active=score>=CFG.APEX_MIN&&dir!==null;
  const cM=(wC/1e6).toFixed(1),pM=(wP/1e6).toFixed(1);
  const detail=dir
    ?`30m: $${cM}M call / $${pM}M put · ${Math.round(ratio*100)}% ${dir}${otmBias?` · OTM ${otmBias}`:''}`
    :`30m neutral — $${cM}M call / $${pM}M put`;
  return{active,direction:dir,score,callFlow:wC,putFlow:wP,otmBias,detail,recentN:recent.length};
}

// Signal 3: RELEASE IMMINENT
function scoreReleaseImminent(){
  const nil=(d)=>({active:false,direction:null,score:0,ivState:'UNKNOWN',ivDir:null,
    absState:'UNKNOWN',absDir:null,tq:1.0,tlbl:'',ivDetail:'',absDetail:'',detail:d});

  // IV State
  let ivState='UNKNOWN',ivDir=null,ivDetail='';
  if(ivHist.length>=3){
    const r=ivHist.slice(-5);
    const atmT=r.at(-1).atmIV-r[0].atmIV;
    const cT=r.at(-1).callIV-r[0].callIV;
    const pT=r.at(-1).putIV-r[0].putIV;
    const skew=r.at(-1).putIV-r.at(-1).callIV;
    if(Math.abs(atmT)<0.005){
      ivState='NEUTRAL';ivDetail=`IV flat ${(r.at(-1).atmIV*100).toFixed(1)}%`;
    } else if(atmT>0.005){
      ivState='EXPANDING';ivDir=pT>cT?'PUT':'CALL';
      ivDetail=`IV ↑ +${(atmT*100).toFixed(1)}% · ${ivDir} leading · skew ${skew>0.01?'put heavy':skew<-0.01?'call heavy':'neutral'}`;
    } else {
      ivState='COMPRESSING';ivDetail=`IV ↓ ${(atmT*100).toFixed(1)}% · premium deflating`;
    }
  } else ivDetail=`IV building (${ivHist.length}/3 reads)`;

  // Absorption State
  let absState='UNKNOWN',absDir=null,absDetail='';
  if(dWaves.length>=3){
    const r=dWaves.slice(-4);
    const effs=r.map(w=>w.efficiency);
    const leff=effs.at(-1);
    const pavg=effs.slice(0,-1).reduce((a,v)=>a+v,0)/(effs.length-1);
    const ratio=pavg>0?leff/pavg:1;
    const lw=dWaves.at(-1);
    if(ratio>1.3){absState='WEAKENING';absDir=lw.dir;absDetail=`Absorption weakening — ${lw.dir} wave ${Math.round(ratio*100-100)}% more efficient · wall thinning`;}
    else if(ratio<0.7){absState='STRONG';absDir=lw.dir==='CALL'?'PUT':'CALL';absDetail=`Absorption strong — ${lw.dir} wave absorbed · passive wall holding`;}
    else{absState='NEUTRAL';absDetail=`Absorption neutral — efficiency stable`;}
  } else absDetail=`Wave data building (${dWaves.length}/3 waves)`;

  // Time quality
  const m=etMins();
  let tq=1.0,tlbl='standard';
  if(m>=600&&m<660){tq=0.90;tlbl='10–11am';}
  else if(m>=660&&m<720){tq=0.85;tlbl='11am–12pm';}
  else if(m>=720&&m<780){tq=0.70;tlbl='12–1pm (lunch)';}
  else if(m>=780&&m<870){tq=1.00;tlbl='1–2:30pm ★';}
  else if(m>=870&&m<930){tq=0.85;tlbl='2:30–3:30pm';}

  // Score
  let cw2=0,pw2=0;
  if(ivState==='EXPANDING'){if(ivDir==='CALL')cw2+=40;else pw2+=40;}
  if(absState==='WEAKENING'){if(absDir==='CALL')cw2+=45;else pw2+=45;}
  const dir=cw2>pw2&&cw2>0?'CALL':pw2>cw2&&pw2>0?'PUT':null;
  let score=0;
  if(dir){
    score=Math.round(Math.max(cw2,pw2)*tq);
    if(ivDir===dir&&absDir===dir) score=Math.round(score*1.25);
    if(ivState==='COMPRESSING') score=Math.round(score*0.60);
  }
  if(tq<0.8) score=Math.round(score*tq);
  score=Math.max(0,Math.min(100,score));
  const active=score>=CFG.APEX_MIN&&dir!==null;
  const detail=dir?`${dir} release — ${ivDetail} · ${absDetail} · ${tlbl}`:`${ivDetail} · ${absDetail} · ${tlbl}`;
  return{active,direction:dir,score,ivState,ivDir,absState,absDir,tq,tlbl,ivDetail,absDetail,detail};
}

function allSignals(){
  return{dp:scoreDealerPressure(),fp:scoreFreshPositioning(),ri:scoreReleaseImminent()};
}

// ════════════════════════════════════════════════════
// LAYER 4 — APEX ENGINE
// ════════════════════════════════════════════════════

function isBlackout(){const m=etMins();return(m>=CFG.BO_AM_S&&m<CFG.BO_AM_E)||(m>=CFG.BO_PM_S&&m<CFG.BO_PM_E);}
function boLabel(){const m=etMins();if(m>=CFG.BO_AM_S&&m<CFG.BO_AM_E)return'BUILDING (pre-10am)';if(m>=CFG.BO_PM_S&&m<CFG.BO_PM_E)return'CLOSED (post-3:30pm)';return null;}

function dpContext(dir,ep){
  const dp=nearDP(ep);
  if(!dp) return{flag:'NEUTRAL',detail:`No dark pool cluster within $${CFG.DP_PROX}`};
  const above=dp.price>ep;
  const pr=dp.tot>=1e9?`$${(dp.tot/1e9).toFixed(1)}B`:`$${(dp.tot/1e6).toFixed(0)}M`;
  const wc=gexLevels&&(Math.abs(dp.price-gexLevels.callWall)<1.5||Math.abs(dp.price-gexLevels.putWall)<1.5);
  let flag,detail;
  if(dir==='PUT'){
    if(above){flag=wc?'CONFLUENCE':'SUPPORTS';detail=`DP $${dp.price.toFixed(2)} (${pr}) above — trapped longs${wc?' · GEX wall':''}` ;}
    else{flag='OPPOSES';detail=`⚠ DP $${dp.price.toFixed(2)} (${pr}) below — support floor`;}
  } else {
    if(!above){flag=wc?'CONFLUENCE':'SUPPORTS';detail=`DP $${dp.price.toFixed(2)} (${pr}) below — institutional support${wc?' · GEX wall':''}` ;}
    else{flag='OPPOSES';detail=`⚠ DP $${dp.price.toFixed(2)} (${pr}) above — overhead resistance`;}
  }
  return{flag,detail,dp};
}

function detectApex(sigs){
  if(isBlackout()||!gexValid||gexStale()) return null;
  if(Date.now()-lastFireAt<CFG.COOLDOWN_MS) return null;
  const{dp,fp,ri}=sigs;
  for(const dir of['CALL','PUT']){
    const act=[dp,fp,ri].filter(s=>s.active&&s.direction===dir);
    if(act.length<2) continue;
    if([dp,fp,ri].some(s=>s.active&&s.direction&&s.direction!==dir)) continue;
    const sc=Math.min(...act.map(s=>s.score));
    if(sc<CFG.APEX_MIN) continue;

    // Wall gate (L9)
    let wBlock=null,wWarn=null;
    if(gexLevels){
      if(dir==='PUT'){const d=gexLevels.callWall-price;if(d>0&&d<=CFG.WALL_BLOCK)wBlock=`Call wall $${gexLevels.callWall} only $${d.toFixed(2)} above`;else if(d>0&&d<=CFG.WALL_WARN)wWarn=`Call wall $${gexLevels.callWall} $${d.toFixed(2)} above`;}
      else{const d=price-gexLevels.putWall;if(d>0&&d<=CFG.WALL_BLOCK)wBlock=`Put wall $${gexLevels.putWall} only $${d.toFixed(2)} below`;else if(d>0&&d<=CFG.WALL_WARN)wWarn=`Put wall $${gexLevels.putWall} $${d.toFixed(2)} below`;}
    }
    if(wBlock) continue;

    const key=`${dir}-${Math.round(price/2)*2}`;
    if(key===lastFireKey&&Date.now()-lastFireAt<CFG.LEVEL_CD_MS) continue;

    const tgt=dir==='CALL'?price+TGT:price-TGT;
    const stp=dir==='CALL'?price-STOP:price+STOP;
    const dpc=dpContext(dir,price);
    const names=act.map(s=>s===dp?'Dealer':s===fp?'Positioning':'Release').join('+');

    lastFireAt=Date.now(); lastFireKey=key;
    return{
      id:Date.now(),type:dir,price,target:tgt,stop:stp,
      score:sc,time:new Date().toLocaleTimeString('en-US',{hour:'2-digit',minute:'2-digit'}),
      detail:`${names} aligned`,dpScore:dp.score,fpScore:fp.score,riScore:ri.score,
      dpc,wWarn,state:'ACTIVE',firedAt:Date.now(),curScore:sc
    };
  }
  return null;
}

function tickApex(sigs){
  if(!apex) return;
  const now=Date.now();
  if((apex.state==='TARGET'||apex.state==='STOP')&&apex.resolvedAt&&now-apex.resolvedAt>30000){logOutcome(apex);apex=null;return;}
  if(apex.state==='EXPIRED'){logOutcome(apex);apex=null;return;}
  if(apex.type==='CALL'){if(price>=apex.target){apex.state='TARGET';apex.resolvedAt=now;return;}if(price<=apex.stop){apex.state='STOP';apex.resolvedAt=now;return;}}
  else{if(price<=apex.target){apex.state='TARGET';apex.resolvedAt=now;return;}if(price>=apex.stop){apex.state='STOP';apex.resolvedAt=now;return;}}
  if(now-apex.firedAt>CFG.EXPIRY_MS){apex.state='EXPIRED';apex.resolvedAt=now;return;}
  const{dp,fp,ri}=sigs;
  const live=[dp,fp,ri].filter(s=>s.active&&s.direction===apex.type).map(s=>s.score);
  apex.curScore=live.length>=2?Math.min(...live):live[0]||0;
  apex.state=apex.curScore<CFG.APEX_MIN?'DEGRADING':'ACTIVE';
}

// ════════════════════════════════════════════════════
// SCAN — throttled entry point
// ════════════════════════════════════════════════════

function scan(){
  const sigs=allSignals();
  tickApex(sigs);
  if(!apex){
    const a=detectApex(sigs);
    if(a){apex=a;logFire(a);if(SMS_ON)sendSMS(buildSMS(a));}
  }
  renderSignals(sigs);
  updStatusBar(sigs);
  if(curTab==='summary') renderSummary();
}

// ════════════════════════════════════════════════════
// LAYER 5 — RENDER
// ════════════════════════════════════════════════════

const G=id=>document.getElementById(id);
const cC=d=>d==='CALL'?'#10b981':'#ef4444';

function updPrice(){
  const ep=G('sb-price');if(!ep)return;
  ep.textContent=price>0?`$${price.toFixed(2)}`:'$—';
  const ec=G('sb-chg');
  if(ec&&price>0){
    ec.textContent=`${chg>=0?'+':''}${chg.toFixed(2)} (${(Math.abs(chg)/(price||1)*100).toFixed(2)}%)`;
    ec.style.color=chg>=0?'#10b981':'#ef4444';
  }
}

function updDots(){
  const s=(id,on)=>{const e=G(id);if(e){e.style.color=on?'#10b981':'#1e293b';}};
  s('sb-poly',CON.poly);s('sb-uw',CON.uw);s('sb-trad',CON.trad);s('sb-ws',CON.ws);
}

function updStatusBar(sigs){
  updPrice();
  if(meta.o) G('sb-o').textContent=meta.o.toFixed(2);
  if(meta.h) G('sb-h').textContent=meta.h.toFixed(2);
  if(meta.l) G('sb-l').textContent=meta.l.toFixed(2);

  // GEX
  if(gexLevels&&gexValid){
    const neg=gexLevels.regime==='NEG';
    const rg=G('sb-regime');
    rg.textContent=neg?'NEG':'POS'+(gexLevels.isManual?' ✎':'');
    rg.style.background=neg?'#0e030388':'#030e0788';
    rg.style.color=neg?'#ef4444':'#10b981';
    G('sb-glevels').textContent=`flip $${gexLevels.flip} · cwall $${gexLevels.callWall} · pwall $${gexLevels.putWall}`;
    G('sb-glevels').style.color='#475569';
  }

  // VWAP
  if(vwap>0){const e=G('sb-vwap');e.textContent=`$${vwap.toFixed(2)}`;e.style.color=price>vwap?'#10b981':'#ef4444';}

  // Flow bias
  if(uwFlow.length){
    const now=Date.now();
    const r=uwFlow.filter(f=>(now-f.ts)<=CFG.FLOW_WIN_MS);
    const cp=r.filter(f=>f.type==='CALL').reduce((a,f)=>a+f.premium,0);
    const pp=r.filter(f=>f.type==='PUT').reduce((a,f)=>a+f.premium,0);
    const b=cp>pp*1.3?'BULLISH':pp>cp*1.3?'BEARISH':'MIXED';
    const ef=G('sb-flow');ef.textContent=b;ef.style.color=b==='BULLISH'?'#10b981':b==='BEARISH'?'#ef4444':'#f59e0b';
  }

  // Signal scores
  if(sigs){
    const{dp,fp,ri}=sigs;
    const sco=s=>`<span style="color:${s.active?(s.direction==='CALL'?'#10b981':'#ef4444'):'#334155'};font-weight:${s.active?700:400}">${s.score}</span>`;
    G('sb-sigs').innerHTML=`Dealer ${sco(dp)} · Positioning ${sco(fp)} · Release ${sco(ri)}`;
  }
}

function renderSignals(sigs){
  renderApexCol(sigs);
  renderSigCards(sigs);
  renderGEXCol();
  const b=G('badge-signals');
  if(b){b.textContent=apex?'★':'';b.style.display=apex?'inline':'none';}
}

function renderApexCol(sigs){
  const el=G('col-apex');if(!el)return;
  const{dp,fp,ri}=sigs;
  const bo=boLabel();
  const a=apex;

  const ac=a?.state==='TARGET'?'#10b981':a?.state==='STOP'?'#ef4444':
           a?.state==='DEGRADING'?'#f97316':a?.state==='ACTIVE'?'#f59e0b':'#1e293b';
  const bg=a?.state==='TARGET'?'#030e07':a?.state==='STOP'?'#0e0303':
           a?.state==='DEGRADING'?'#0f0500':a?.state==='ACTIVE'?'#0f0900':'#06070f';
  const stlbl=a?.state==='TARGET'?'✓ TARGET HIT':a?.state==='STOP'?'✗ STOP HIT':
              a?.state==='DEGRADING'?'⚠ DEGRADING':a?.state==='ACTIVE'?'★ APEX FIRED':'◈ MONITORING';

  // Pre-fire: best available score
  let dsc=0,ddir='—';
  if(a){dsc=a.curScore||a.score;ddir=a.type;}
  else{
    for(const d of['CALL','PUT']){
      const ac2=[dp,fp,ri].filter(s=>s.active&&s.direction===d);
      if(ac2.length>=2){const s2=Math.min(...ac2.map(s=>s.score));if(s2>dsc){dsc=s2;ddir=d;}}
    }
  }

  // Context badges
  let ctx='';
  if(a?.state==='ACTIVE'){
    // Delta ticks
    if(CON.ws&&dTicks.length>20){
      const w=dTicks.slice(-50);const ups=w.filter(t=>t.dir>0).length;const rat=ups/w.length;
      const td=rat>0.55?'CALL':rat<0.45?'PUT':null;
      if(td){const conf=td===a.type;const c2=conf?'#10b981':'#f59e0b';
        ctx+=`<div class="ctx" style="background:${c2}15;border:1px solid ${c2}40;color:${c2}"><span class="ctx-lbl">Δ TICKS ${conf?'CONFIRMS':'DISAGREES'}</span><span style="margin-left:6px">${Math.round(rat*100)}% buying · ${dTicks.length} ticks</span></div>`;}
    }
    // Absorption
    if(dWaves.length>=3){
      const ri2=scoreReleaseImminent();
      if(ri2.absState!=='UNKNOWN'){
        const c2=ri2.absState==='WEAKENING'?'#10b981':ri2.absState==='STRONG'?'#ef4444':'#475569';
        ctx+=`<div class="ctx" style="background:${c2}15;border:1px solid ${c2}40;color:${c2};margin-top:5px"><span class="ctx-lbl">ABSORPTION ${ri2.absState}</span><span style="margin-left:6px">${ri2.absDetail}</span></div>`;
      }
    }
    // Dark Pool
    if(a.dpc&&a.dpc.flag!=='NEUTRAL'){
      const c2=a.dpc.flag==='OPPOSES'?'#ef4444':a.dpc.flag==='CONFLUENCE'?'#a855f7':'#10b981';
      ctx+=`<div class="ctx" style="background:${c2}15;border:1px solid ${c2}40;color:${c2};margin-top:5px"><span class="ctx-lbl">DARK POOL ${a.dpc.flag}</span><span style="margin-left:6px">${a.dpc.detail}</span></div>`;
    }
    // Wall warn
    if(a.wWarn){
      ctx+=`<div class="ctx" style="background:#f59e0b15;border:1px solid #f59e0b40;color:#f59e0b;margin-top:5px"><span class="ctx-lbl">⚠ GEX WALL</span><span style="margin-left:6px">${a.wWarn}</span></div>`;
    }
  }

  // Pre-fire needed
  let needed='';
  if(!a&&!bo){
    for(const d of['CALL','PUT']){
      const ac2=[dp,fp,ri].filter(s=>s.active&&s.direction===d);
      const op=[dp,fp,ri].filter(s=>s.active&&s.direction&&s.direction!==d);
      if(ac2.length>=2&&op.length===0){needed='';break;}
      if(ac2.length===1&&op.length===0){
        const names=[{s:dp,n:'Dealer'},{s:fp,n:'Positioning'},{s:ri,n:'Release'}];
        const miss=names.filter(x=>!x.s.active||x.s.direction!==d).map(x=>x.n);
        needed=`Need ${miss.join(' or ')} to confirm ${d}`;
      }
    }
    if(!needed&&ddir==='—') needed='Need 2-of-3 signals aligned';
  }

  el.innerHTML=`
    <div class="apex-card" style="background:${bg};border-color:${ac};${a?.state==='ACTIVE'?`box-shadow:0 0 28px ${ac}22;`:''}">
      <div class="apex-state" style="color:${ac}">${stlbl}</div>
      <div class="apex-dir" style="color:${ddir!=='—'?cC(ddir):'#1e293b'}">SPY ${ddir}</div>
      <div class="apex-sub">${bo?`Blackout — ${bo}`:a?`${a.detail} · ${a.time}`:needed||'Monitoring for setup'}</div>

      ${a?.state==='ACTIVE'?`
        <div class="apex-grid">
          <div class="apex-cell"><div class="apex-cl">ENTRY</div><div class="apex-cv" style="color:#e2e8f0">$${a.price.toFixed(2)}</div></div>
          <div class="apex-cell"><div class="apex-cl">TARGET</div><div class="apex-cv" style="color:#10b981">$${a.target.toFixed(2)}</div></div>
          <div class="apex-cell"><div class="apex-cl">STOP</div><div class="apex-cv" style="color:#ef4444">$${a.stop.toFixed(2)}</div></div>
        </div>
        <div style="font-size:10px;color:#334155;margin-bottom:4px">Dealer ${a.dpScore} · Positioning ${a.fpScore} · Release ${a.riScore}</div>
        ${ctx}
        <button onclick="apex=null;scan()" style="margin-top:10px;font-size:9px;padding:3px 10px;border-radius:3px;background:#1e293b;border:1px solid #334155;color:#64748b;cursor:pointer">✕ dismiss</button>
      `:''}
      ${a?.state==='TARGET'?`<div style="font-size:13px;font-weight:700;color:#10b981;margin:8px 0">✓ TARGET $${a.target.toFixed(2)} reached</div>`:''}
      ${a?.state==='STOP'?`<div style="font-size:13px;font-weight:700;color:#ef4444;margin:8px 0">✗ STOP $${a.stop.toFixed(2)} hit</div>`:''}
      ${a?.state==='DEGRADING'?`<div style="font-size:11px;color:#f97316;margin:8px 0">Score ${a.curScore} · signals weakening <button onclick="apex=null;scan()" style="margin-left:8px;font-size:9px;padding:2px 7px;border-radius:3px;background:#1e293b;border:1px solid #334155;color:#64748b;cursor:pointer">clear</button></div>`:''}

      ${!a?`
        <div style="margin-top:8px;border-top:1px solid #0a0a14;padding-top:8px">
          ${[{s:dp,n:'Dealer'},{s:fp,n:'Positioning'},{s:ri,n:'Release'}].map(x=>{
            const c2=x.s.active?cC(x.s.direction):'#1e293b';
            return `<div style="display:flex;justify-content:space-between;align-items:center;padding:3px 0">
              <span style="font-size:10px;color:${x.s.active?'#475569':'#1e293b'}">${x.n}</span>
              <span style="font-size:12px;font-weight:700;color:${c2}">${x.s.score}</span>
            </div>`;
          }).join('')}
        </div>
      `:''}

      <div class="apex-score-row">
        <span class="apex-score" style="color:${ac}">${dsc}</span>
        <span class="apex-denom">/ 100</span>
      </div>
      <div class="apex-bar"><div class="apex-fill" style="width:${Math.min(100,dsc)}%;background:${ac}"></div></div>
    </div>
    <div style="text-align:center;font-size:9px;color:#0f172a;margin-top:6px;letter-spacing:1px">DEALER · POSITIONING · RELEASE · 2-OF-3</div>
  `;
}

function renderSigCards(sigs){
  const el=G('col-signals');if(!el)return;
  const{dp,fp,ri}=sigs;
  const bo=boLabel();

  const card=(lbl,sub,s,primary)=>{
    const c2=s.active?cC(s.direction):'#1e293b';
    const cls=s.active?(s.direction==='CALL'?'call':'put'):'';
    const db=s.direction?`<span class="badge" style="background:${c2}22;color:${c2};border:1px solid ${c2}44">${s.direction}</span>`:'';
    return `<div class="sc ${cls}">
      <div>
        <div class="sc-type">${primary?'PRIMARY':'SIGNAL'}</div>
        <div class="sc-name${s.active?' on':''}">${lbl}</div>
        <div class="sc-sub">${sub}</div>
        <div class="sc-detail${s.active?' on':''}" title="${s.detail||''}">${s.detail||'—'}</div>
        <div style="margin-top:4px">${db}</div>
      </div>
      <div>
        <div class="sc-score" style="color:${c2}">${s.score}</div>
        <div class="sc-denom">/ 100</div>
      </div>
      <div class="sc-bar"><div class="sc-fill" style="width:${Math.min(100,s.score)}%;background:${c2}"></div></div>
    </div>`;
  };

  const dpSub=gexLevels?`Flip $${gexLevels.flip} · ${gexLevels.blendActive?'vol-adaptive':'OI baseline'}`:'Waiting for GEX';
  const fpSub=`30m OTM flow · fresh bets${fp.otmBias?' · OTM:'+fp.otmBias:''}`;
  const riSub=`IV:${ri.ivState||'—'} · Abs:${ri.absState||'—'} · ${ri.tlbl||''}`;
  const bo2=bo?`<div style="background:#0a0a14;border-radius:6px;padding:10px 12px;text-align:center;color:#1e293b;font-size:10px;letter-spacing:1px;margin-bottom:6px">⊘ BLACKOUT — ${bo}</div>`:'';

  el.innerHTML=bo2+
    card('Dealer Pressure',dpSub,dp,true)+
    card('Fresh Positioning',fpSub,fp,false)+
    card('Release Imminent',riSub,ri,false)+
    `<div style="padding:5px 0;font-size:10px;color:#0f172a;text-align:center">Time: ${ri.tlbl||'—'} · Quality ${Math.round((ri.tq||1)*100)}%</div>`;
}

function renderGEXCol(){
  const el=G('col-gex');if(!el)return;
  if(!gexLevels||!gexValid){el.innerHTML=`<div style="color:#1e293b;font-size:11px">GEX loading…</div>`;return;}
  const g=gexLevels;
  const neg=g.regime==='NEG';
  const rc=neg?'#ef4444':'#10b981';

  const row=(l,v,c,arrow='')=>`
    <div class="gl-row">
      <span class="gl-lbl">${l}</span>
      <span class="gl-val" style="color:${c}">${v}${arrow?` <span style="font-size:9px">${arrow}</span>`:''}</span>
    </div>`;

  el.innerHTML=`
    <div style="font-size:9px;color:#1e293b;letter-spacing:2px;font-weight:700;margin-bottom:6px">GEX LEVELS</div>
    ${row('Regime',neg?'NEGATIVE':'POSITIVE'+(g.isManual?' ✎':''),rc)}
    ${row('Flip','$'+g.flip,'#e2e8f0')}
    <div style="font-size:9px;color:#334155;padding:2px 0 5px">${price>g.flip?`+$${(price-g.flip).toFixed(2)} above`:`-$${(g.flip-price).toFixed(2)} below`}</div>
    ${row('Call Wall','$'+g.callWall,'#10b981','↑')}
    ${row('Put Wall','$'+g.putWall,'#ef4444','↓')}
    ${vwap>0?row('VWAP','$'+vwap.toFixed(2),price>vwap?'#10b981':'#ef4444'):''}

    <div style="margin-top:10px;font-size:9px;color:#1e293b;letter-spacing:2px;font-weight:700;margin-bottom:4px">HEDGE ACCEL</div>
    <div style="display:flex;justify-content:space-between;padding:3px 0"><span style="color:#ef4444">↓ PUT</span><span style="color:#e2e8f0;font-weight:700">${g.accelD.toFixed(0)}M/$0.50</span></div>
    <div style="display:flex;justify-content:space-between;padding:3px 0"><span style="color:#10b981">↑ CALL</span><span style="color:#e2e8f0;font-weight:700">${g.accelU.toFixed(0)}M/$0.50</span></div>
    <div style="font-size:9px;margin-top:2px;color:${g.accelD>g.accelU*1.2?'#ef4444':g.accelU>g.accelD*1.2?'#10b981':'#334155'}">${g.accelD>g.accelU*1.2?'PUT pressure dominant':g.accelU>g.accelD*1.2?'CALL pressure dominant':'Balanced'}</div>

    <div style="margin-top:10px;font-size:9px;color:#1e293b;letter-spacing:2px;font-weight:700;margin-bottom:4px">IV</div>
    ${ivHist.length?`
      <div style="font-size:12px;font-weight:700;color:#e2e8f0">ATM ${(ivHist.at(-1).atmIV*100).toFixed(1)}%</div>
      <div style="font-size:10px;color:#475569;margin-top:2px">Call ${(ivHist.at(-1).callIV*100).toFixed(1)}% · Put ${(ivHist.at(-1).putIV*100).toFixed(1)}%</div>
      <div style="font-size:9px;color:#334155;margin-top:2px">${ivHist.length>=3?`${allSignals().ri.ivState}`:''}</div>
    `:`<div style="font-size:10px;color:#1e293b">Building…</div>`}

    <div style="margin-top:10px;font-size:9px;color:#0f172a;line-height:1.6">
      ${gexLastAt?`Updated ${gexLastAt.toLocaleTimeString('en-US',{hour:'2-digit',minute:'2-digit',second:'2-digit'})}`:''}<br>
      ${g.contracts} contracts · ±$${CFG.STRIKE_BAND}<br>
      ${g.blendActive?'Vol-adaptive blend active':'OI baseline'}
    </div>`;
}

function renderFlowTab(){
  const el=G('flow-body');if(!el)return;
  if(!uwFlow.length){el.innerHTML=`<div style="padding:16px;color:#1e293b">No flow — UW key required</div>`;return;}
  const now=Date.now();
  el.innerHTML=uwFlow.slice(0,100).map(f=>{
    const age=Math.round((now-f.ts)/60000);
    const c2=f.type==='CALL'?'#10b981':'#ef4444';
    const pr=f.premium>=1e6?`$${(f.premium/1e6).toFixed(1)}M`:`$${(f.premium/1e3).toFixed(0)}K`;
    const otm=Math.abs((f.strike||0)-price)>CFG.OTM_BAND;
    const flags=[f.sweep?'SWEEP':'',otm?'OTM':'',age<=5?'FRESH':''].filter(Boolean).join(' ');
    return `<div class="flow-row">
      <span style="color:#334155">${age}m</span>
      <span style="color:${c2};font-weight:700">${f.type}</span>
      <span style="color:#e2e8f0">$${f.strike}</span>
      <span style="color:#475569">${(f.expiry||'').slice(5)||f.expiry}</span>
      <span style="color:${c2};font-weight:700">${pr}</span>
      <span style="color:#334155;font-size:9px">${flags}</span>
    </div>`;
  }).join('');
}

function renderGEXTab(){
  const rows=G('gex-rows'),st=G('gex-status');if(!rows)return;
  if(!gexLevels||!gexValid){rows.innerHTML=`<div style="padding:16px;color:#1e293b">GEX not computed</div>`;if(st)st.textContent='waiting for chain';return;}
  const g=gexLevels;
  if(st) st.textContent=`flip $${g.flip} · cwall $${g.callWall} · pwall $${g.putWall} · ${g.contracts} contracts · ${g.blendActive?'vol-adaptive':'OI-only'}${g.isManual?' · MANUAL':''} · age ${gexAge().toFixed(1)}m`;
  rows.innerHTML=g.strikes.slice().sort((a,b)=>b-a).map(s=>{
    const b=g.by[s];
    const gv=(b.netGEX/1e6).toFixed(1);
    const c2=+gv>0?'#10b981':'#ef4444';
    const flags=(s===g.flip?'⬡FLIP':(s===g.callWall?'↑CW':(s===g.putWall?'↓PW':'')))+
                (s===Math.round(price)?' ←':'')+
                (s>price-0.5&&s<price+0.5?' ←PRICE':'');
    const pct=Math.round((b.repo||0)*100);
    return `<div class="gex-row" style="${s===g.flip?'background:#0a0a14;':''};${Math.abs(s-price)<0.5?'border-left:2px solid #1d4ed8;':''}">
      <span style="color:${Math.abs(s-price)<1?'#e2e8f0':'#475569'};font-weight:${Math.abs(s-price)<1?700:400}">$${s}${flags?` <span style="font-size:9px;color:#334155">${flags}</span>`:''}</span>
      <span style="color:${c2};font-weight:700">${gv}M</span>
      <span style="color:${pct>30?'#f59e0b':'#334155'}">${pct}%</span>
      <span style="color:#10b981;font-size:10px">${(b.callOI||0).toLocaleString()}</span>
      <span style="color:#ef4444;font-size:10px">${(b.putOI||0).toLocaleString()}</span>
    </div>`;
  }).join('');
}

function renderSummary(){
  const el=G('summary-body');if(!el)return;
  const log=loadLog();
  const today=tradDate();
  const day=log[today]||{fires:[]};
  const wins=day.fires.filter(f=>f.outcome==='win').length;
  const losses=day.fires.filter(f=>f.outcome==='loss').length;
  const open=day.fires.filter(f=>!f.outcome).length;
  el.innerHTML=`
    <div class="sum-sec">
      <div class="sum-ttl">TODAY — ${today}</div>
      <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:8px">
        ${[['FIRES',day.fires.length,'#e2e8f0'],['WINS',wins,'#10b981'],['LOSSES',losses,'#ef4444'],['OPEN',open,'#f59e0b']].map(([l,v,c])=>`
          <div style="background:#0a0a14;border-radius:6px;padding:8px 10px">
            <div style="font-size:9px;color:#334155;letter-spacing:1px">${l}</div>
            <div style="font-size:22px;font-weight:700;color:${c}">${v}</div>
          </div>`).join('')}
      </div>
    </div>
    <div class="sum-sec">
      <div class="sum-ttl">FIRES</div>
      ${day.fires.length?day.fires.map(f=>`
        <div style="display:flex;justify-content:space-between;align-items:center;padding:5px 0;border-bottom:1px solid #06070f;font-size:11px">
          <span style="color:${f.type==='CALL'?'#10b981':'#ef4444'};font-weight:700">${f.type}</span>
          <span style="color:#475569">$${f.price?.toFixed(2)||'—'}</span>
          <span style="color:#334155">${f.time||'—'}</span>
          <span style="color:#475569">Score ${f.score}</span>
          <span style="color:${f.outcome==='win'?'#10b981':f.outcome==='loss'?'#ef4444':'#334155'}">${f.outcome||'open'}</span>
        </div>`).join(''):`<div style="color:#1e293b;font-size:11px">No fires today</div>`}
    </div>
    <div style="padding:10px 16px">
      <button class="btn" onclick="sendSummary()" style="font-size:10px;padding:5px 12px">📱 SEND EVENING SUMMARY</button>
      <button class="btn" onclick="clearToday()" style="margin-left:8px;font-size:10px;padding:5px 12px;color:#ef4444;border-color:#ef444430">CLEAR TODAY</button>
    </div>`;
}

// ════════════════════════════════════════════════════
// LOGGING
// ════════════════════════════════════════════════════

function loadLog(){try{return JSON.parse(localStorage.getItem(LOGKEY)||'{}')}catch{return{}}}
function saveLog(l){localStorage.setItem(LOGKEY,JSON.stringify(l));}

function logFire(a){
  const l=loadLog(),d=tradDate();
  if(!l[d])l[d]={fires:[]};
  l[d].fires.push({id:a.id,type:a.type,price:a.price,target:a.target,stop:a.stop,
    score:a.score,time:a.time,firedAt:a.firedAt});
  saveLog(l);
}

function logOutcome(a){
  const l=loadLog(),d=tradDate();
  if(!l[d]?.fires) return;
  const f=l[d].fires.find(x=>x.id===a.id);
  if(f){f.outcome=a.state==='TARGET'?'win':a.state==='STOP'?'loss':'scratch';f.resolvedAt=Date.now();}
  saveLog(l);
}

function clearToday(){
  if(!confirm('Clear today\'s log?')) return;
  const l=loadLog();delete l[tradDate()];saveLog(l);renderSummary();
}

// ════════════════════════════════════════════════════
// SMS
// ════════════════════════════════════════════════════

function buildSMS(a){
  return`GEX SNIPER ★ APEX\n${a.type} SPY\nEntry $${a.price.toFixed(2)} · Target $${a.target.toFixed(2)} · Stop $${a.stop.toFixed(2)}\nScore ${a.score} · ${a.detail} · ${a.time}`;
}

async function sendSMS(msg){
  if(!K.ptoken||!K.puser) return;
  try{
    await fetch('https://api.pushover.net/1/messages.json',{
      method:'POST',headers:{'Content-Type':'application/json'},
      body:JSON.stringify({token:K.ptoken,user:K.puser,message:msg,title:'GEX Sniper'})
    });
  }catch(e){}
}

async function sendAMBrief(){
  if(!gexLevels||!gexValid){alert('GEX not loaded yet');return;}
  const g=gexLevels;
  const msg=`GEX SNIPER — AM BRIEF\n${tradDate()}\nFlip $${g.flip} · CWall $${g.callWall} · PWall $${g.putWall}\nRegime: ${g.regime==='NEG'?'NEGATIVE (dealers amplify)':'POSITIVE (dealers mean-revert)'}\nVWAP $${vwap.toFixed(2)}\nAccel ↓${g.accelD.toFixed(0)}M ↑${g.accelU.toFixed(0)}M\n${g.blendActive?'Volume-adaptive blend active':'OI baseline (volume thin)'}`;
  await sendSMS(msg);
  alert('AM Brief sent!');
}

async function sendSummary(){
  const l=loadLog(),d=tradDate(),day=l[d]||{fires:[]};
  const wins=day.fires.filter(f=>f.outcome==='win').length;
  const loss=day.fires.filter(f=>f.outcome==='loss').length;
  const msg=`GEX SNIPER — EVENING SUMMARY\n${d}\nFires: ${day.fires.length} · Wins: ${wins} · Losses: ${loss}\n${day.fires.map(f=>`${f.type} $${f.price?.toFixed(2)} → ${f.outcome||'open'}`).join('\n')}`;
  await sendSMS(msg);
  alert('Summary sent!');
}

// ════════════════════════════════════════════════════
// MANUAL GEX OVERRIDE
// ════════════════════════════════════════════════════

function applyManual(){
  const f=+G('ov-flip').value,c=+G('ov-cwall').value,p=+G('ov-pwall').value;
  if(!f||!c||!p){alert('Enter all three values');return;}
  gexOverride={flip:f,cwall:c,pwall:p};
  if(gexLevels) gexLevels=computeGEX([]); // re-apply override
  scan();
}
function clearManual(){
  gexOverride=null;G('ov-flip').value='';G('ov-cwall').value='';G('ov-pwall').value='';
  scan();
}

// ════════════════════════════════════════════════════
// SETTINGS
// ════════════════════════════════════════════════════

function openSetting(){
  G('s-poly').value=K.poly;G('s-uw').value=K.uw;G('s-trad').value=K.trad;
  G('s-ptoken').value=K.ptoken;G('s-puser').value=K.puser;
  G('s-tgt').value=TGT;G('s-stop').value=STOP;G('s-sms').checked=SMS_ON;
  G('settings').classList.add('on');
}
function closeSetting(){G('settings').classList.remove('on');}
function saveSetting(){
  K.poly=G('s-poly').value.trim()||K.poly;
  K.uw=G('s-uw').value.trim()||K.uw;
  K.trad=G('s-trad').value.trim()||K.trad;
  K.ptoken=G('s-ptoken').value.trim()||K.ptoken;
  K.puser=G('s-puser').value.trim()||K.puser;
  TGT=+G('s-tgt').value||TGT;STOP=+G('s-stop').value||STOP;SMS_ON=G('s-sms').checked;
  saveKeys();closeSetting();
}
function saveKeys(){localStorage.setItem('gexsniper_keys',JSON.stringify({...K,TGT,STOP,SMS_ON}));}
function loadKeys(){
  try{const s=JSON.parse(localStorage.getItem('gexsniper_keys')||'{}');
    K.poly=s.poly||'';K.uw=s.uw||'';K.trad=s.trad||'';K.ptoken=s.ptoken||'';K.puser=s.puser||'';
    TGT=s.TGT||CFG.APEX_TGT;STOP=s.STOP||CFG.APEX_STOP;SMS_ON=s.SMS_ON||false;
  }catch(e){}
}
function disconnect(){if(!confirm('Disconnect and return to setup?'))return;location.reload();}

// ════════════════════════════════════════════════════
// TAB SWITCHING
// ════════════════════════════════════════════════════

function switchTab(t){
  curTab=t;
  document.querySelectorAll('.tab').forEach(el=>el.classList.toggle('on',el.textContent.toLowerCase().startsWith(t)));
  document.querySelectorAll('.panel').forEach(el=>el.classList.remove('on'));
  const p=G('p-'+t);if(p)p.classList.add('on');
  if(t==='flow') renderFlowTab();
  if(t==='gex') renderGEXTab();
  if(t==='summary') renderSummary();
}

// ════════════════════════════════════════════════════
// LAUNCH
// ════════════════════════════════════════════════════

async function launch(){
  const poly=G('k-poly').value.trim();
  if(!poly){const e=G('setup-err');e.textContent='Polygon key required';e.style.display='block';return;}
  K.poly=poly;
  K.uw=G('k-uw').value.trim();
  K.trad=G('k-trad').value.trim();
  K.ptoken=G('k-ptoken').value.trim();
  K.puser=G('k-puser').value.trim();
  saveKeys();
  G('setup').style.display='none';
  G('app').style.display='flex';
  startApp();
}

function startApp(){
  connectWS();

  // Clock
  ivClock=setInterval(()=>{
    const e=G('sb-clock');
    if(e) e.textContent=etNow().toLocaleTimeString('en-US',{hour:'2-digit',minute:'2-digit',second:'2-digit',timeZone:'America/New_York'});
  },1000);

  // Initial data load
  fetchPrice();fetchCandles();
  if(K.trad) fetchGEX();
  if(K.uw){fetchFlow();fetchDP();}

  // Intervals
  ivPrice  =setInterval(()=>{fetchPrice();},30000);
  ivCandle =setInterval(()=>{fetchCandles();},60000);
  ivGEX    =setInterval(()=>{if(K.trad)fetchGEX();},60000);
  ivFlow   =setInterval(()=>{if(K.uw)fetchFlow();},60000);

  // Fallback scan for when WebSocket isn't available
  setInterval(()=>{if(!CON.ws)scan();},3000);

  // Initial render
  setTimeout(scan,500);
}

// ════════════════════════════════════════════════════
// INIT — pre-fill keys if saved
// ════════════════════════════════════════════════════
(function init(){
  loadKeys();
  if(K.poly){
    G('k-poly').value=K.poly;G('k-uw').value=K.uw;
    G('k-trad').value=K.trad;G('k-ptoken').value=K.ptoken;G('k-puser').value=K.puser;
  }
})();

</script>
</body>
</html>
